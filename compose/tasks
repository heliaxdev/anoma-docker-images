#!/usr/bin/env bash

set -euo pipefail

export ANOMA_TAG=${ANOMA_TAG:-v0.2.0}
export ANOMA_IMAGE=${ANOMA_IMAGE:-"heliaxdev/anoma:${ANOMA_TAG}"}

# network settings
export NET_ADDR=10.0.0.0/24
export NET_VALIDATOR_1=10.0.0.10
export NET_VALIDATOR_2=10.0.0.20
export NET_VALIDATOR_3=10.0.0.30
export NET_VALIDATOR_4=10.0.0.40

PORT_P2P=26656

# anoma repo: genesis/internal-testnet.toml
GENESIS_PATH=genesis.toml
CHAIN_PREFIX=anoma-internal-0

__init-network(){
	now=$(TZ=utc date -Iseconds)
	tomlq -t '
	setpath(["genesis_time"]; "'"$now"'") |
	setpath(["validator","validator-1","net_address"]; "'"$NET_VALIDATOR_1:$PORT_P2P"'") |
	setpath(["validator","validator-2","net_address"]; "'"$NET_VALIDATOR_2:$PORT_P2P"'") |
	setpath(["validator","validator-3","net_address"]; "'"$NET_VALIDATOR_3:$PORT_P2P"'") |
	setpath(["validator","validator-4","net_address"]; "'"$NET_VALIDATOR_4:$PORT_P2P"'")
	' < genesis-template.toml > "$GENESIS_PATH"

	docker run -it --rm \
		--entrypoint "" \
		-v "$PWD:/data" \
		-w /data \
		-u "$(id -u "${USER}"):$(id -g "${USER}")" \
		"$ANOMA_IMAGE" anomac utils init-network \
		--unsafe-dont-encrypt \
		--genesis-path "$GENESIS_PATH" \
		--chain-prefix "$CHAIN_PREFIX"
}

__docker-compose(){
	# lookup the chain id generated by init-network
	CHAIN_ID=$(tomlq -r .default_chain_id <global-config.toml)
	export CHAIN_ID
	exec docker-compose "$@"
}

__setup-nftables(){
	bridge=br-$(docker network inspect anoma-testnet -f '{{printf "%.12s" .Id}}')
	sudo nft add element inet filter docker-ifname \{ "$bridge" \}
	sudo nft add element ip nat docker-ifname \{ "$bridge" \}
	sudo nft add element ip nat docker-addr \{ "$NET_ADDR" \}
}

cmd=$1
shift
case $cmd in
	init ) __init-network "$@" ;;
	compose ) __docker-compose "$@" ;;
	setup-nftables ) __setup-nftables "$@" ;;
	* ) echo "unknown command: $cmd" >&2; exit 2 ;;
esac
